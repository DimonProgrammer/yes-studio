---
import BlogLayout from '../layouts/BlogLayout.astro'
import RelatedPosts from '../components/RelatedPosts.astro'
import { getAllSlugs, getPost, getRelatedPosts, urlFor } from '../lib/sanity'
import { toHTML } from '@portabletext/to-html'

export async function getStaticPaths() {
  const slugs = await getAllSlugs()
  return slugs.map((s: any) => ({ params: { slug: s.slug } }))
}

const { slug } = Astro.params
const post = await getPost(slug!)
if (!post) return Astro.redirect('/blog/')

const relatedPosts = post.category?.slug
  ? await getRelatedPosts(post.category.slug.current, post._id)
  : []

const coverUrl = post.coverImage
  ? urlFor(post.coverImage).width(1200).height(630).format('webp').url()
  : undefined

const date = new Date(post.publishedAt).toLocaleDateString('ru-RU', {
  day: 'numeric', month: 'long', year: 'numeric'
})

// Render Portable Text to HTML
const bodyHtml = post.body ? toHTML(post.body, {
  components: {
    types: {
      image: ({ value }: any) => {
        const src = urlFor(value).width(800).format('webp').url()
        return `<figure class="article-image">
          <img src="${src}" alt="${value.alt || ''}" loading="lazy" width="800">
          ${value.caption ? `<figcaption>${value.caption}</figcaption>` : ''}
        </figure>`
      },
    },
    marks: {
      link: ({ children, value }: any) => {
        const target = value.blank ? ' target="_blank" rel="noopener noreferrer"' : ''
        return `<a href="${value.href}"${target}>${children}</a>`
      },
    },
  },
}) : ''
---

<BlogLayout
  title={post.seoTitle || post.title}
  description={post.seoDescription || post.excerpt}
  ogImage={coverUrl}
  ogType="article"
  canonical={`https://yes-studio.agency/blog/${slug}/`}
>
  <article class="article">
    <div class="container">
      <!-- Breadcrumb -->
      <nav class="breadcrumb" aria-label="Навигация">
        <a href="/">Главная</a>
        <span class="breadcrumb__sep">/</span>
        <a href="/blog/">Блог</a>
        <span class="breadcrumb__sep">/</span>
        <span>{post.title}</span>
      </nav>

      <!-- Article Header -->
      <header class="article-header">
        <div class="article-meta">
          {post.category && <span class="article-meta__category">{post.category.title}</span>}
          <span>{date}</span>
          {post.readTime && <span> · {post.readTime} мин чтения</span>}
        </div>
        <h1 class="article-title">{post.title}</h1>
        <p class="article-excerpt">{post.excerpt}</p>
      </header>

      <!-- Cover Image -->
      {coverUrl && (
        <div class="article-cover">
          <img src={coverUrl} alt={post.coverImage?.alt || post.title} width="1200" height="630">
        </div>
      )}

      <!-- Content + Sidebar -->
      <div class="article-layout">
        <div class="article-body" set:html={bodyHtml} />

        <aside class="article-sidebar">
          <div class="sidebar-cta">
            <p class="sidebar-cta__title">Хочешь попробовать?</p>
            <p class="sidebar-cta__text">Оставь заявку — мы всему научим и поддержим на старте</p>
            <a href="https://t.me/studio_yes" class="sidebar-cta__button">Написать в Telegram</a>
          </div>

          <div class="sidebar-contact">
            <p class="sidebar-contact__label">Позвонить</p>
            <a href="tel:+79282348339" class="sidebar-contact__phone">+7 (928) 234-83-39</a>
          </div>

          {post.tags && post.tags.length > 0 && (
            <div class="sidebar-tags">
              <p class="sidebar-tags__label">Теги</p>
              <div class="sidebar-tags__list">
                {post.tags.map((tag: string) => (
                  <span class="sidebar-tag">{tag}</span>
                ))}
              </div>
            </div>
          )}
        </aside>
      </div>
    </div>
  </article>

  <!-- Related Posts -->
  <RelatedPosts posts={relatedPosts} />

  <!-- CTA Block -->
  <section class="post-cta">
    <div class="container">
      <div class="post-cta__inner">
        <h2 class="post-cta__title">Готова начать зарабатывать?</h2>
        <p class="post-cta__text">Оставь заявку — мы расскажем всё на личной встрече</p>
        <a href="https://t.me/studio_yes" class="post-cta__button">Написать в Telegram</a>
      </div>
    </div>
  </section>

  <!-- Schema.org: BlogPosting + BreadcrumbList -->
  <script type="application/ld+json" set:html={JSON.stringify([
    {
      "@context": "https://schema.org",
      "@type": "BlogPosting",
      "headline": post.title,
      "description": post.excerpt,
      "image": coverUrl,
      "datePublished": post.publishedAt,
      "dateModified": post.publishedAt,
      "author": { "@type": "Organization", "name": "YES Studio" },
      "publisher": {
        "@type": "Organization",
        "name": "YES Studio",
        "url": "https://yes-studio.agency/"
      },
      "mainEntityOfPage": `https://yes-studio.agency/blog/${slug}/`
    },
    {
      "@context": "https://schema.org",
      "@type": "BreadcrumbList",
      "itemListElement": [
        { "@type": "ListItem", "position": 1, "name": "Главная", "item": "https://yes-studio.agency/" },
        { "@type": "ListItem", "position": 2, "name": "Блог", "item": "https://yes-studio.agency/blog/" },
        { "@type": "ListItem", "position": 3, "name": post.title }
      ]
    }
  ])} />
</BlogLayout>

<style>
  .breadcrumb {
    padding: 24px 0;
    font-size: 0.8rem; color: var(--text-muted);
  }
  .breadcrumb a { transition: color 0.2s; }
  .breadcrumb a:hover { color: var(--accent); }
  .breadcrumb__sep { margin: 0 8px; }

  .article-header { max-width: 800px; margin-bottom: 40px; }
  .article-meta {
    font-size: 0.8rem; color: var(--text-muted);
    display: flex; gap: 8px; align-items: center;
    margin-bottom: 16px;
  }
  .article-meta__category {
    background: var(--accent);
    color: #fff;
    padding: 3px 12px;
    border-radius: var(--radius-btn);
    font-size: 0.7rem; font-weight: 600;
    text-transform: uppercase; letter-spacing: 0.06em;
  }
  .article-title {
    font-family: var(--font-heading);
    font-size: clamp(2rem, 4vw, 3rem);
    line-height: 1.15;
    margin-bottom: 16px;
  }
  .article-excerpt {
    font-size: 1.15rem; color: var(--text-body);
    line-height: 1.65; max-width: 640px;
  }

  .article-cover {
    margin-bottom: 48px;
    border-radius: var(--radius-card);
    overflow: hidden;
  }
  .article-cover img { width: 100%; height: auto; }

  .article-layout {
    display: grid;
    grid-template-columns: 1fr 320px;
    gap: 60px;
    align-items: start;
  }

  /* Article Body Typography */
  .article-body { font-size: 1.05rem; line-height: 1.75; color: var(--text-body); }
  .article-body :global(h2) {
    font-family: var(--font-heading); font-size: 1.8rem;
    margin: 48px 0 16px; line-height: 1.2;
  }
  .article-body :global(h3) {
    font-family: var(--font-heading); font-size: 1.4rem;
    margin: 36px 0 12px; line-height: 1.3;
  }
  .article-body :global(p) { margin-bottom: 20px; }
  .article-body :global(a) { color: var(--accent); text-decoration: underline; }
  .article-body :global(a:hover) { color: var(--accent-light); }
  .article-body :global(strong) { font-weight: 600; color: var(--text); }
  .article-body :global(blockquote) {
    border-left: 3px solid var(--accent);
    padding-left: 20px; margin: 24px 0;
    font-style: italic; color: var(--text-muted);
  }
  .article-body :global(ul), .article-body :global(ol) {
    margin: 16px 0; padding-left: 24px;
  }
  .article-body :global(li) { margin-bottom: 8px; }
  .article-body :global(.article-image) { margin: 32px 0; }
  .article-body :global(.article-image img) { border-radius: 12px; }
  .article-body :global(.article-image figcaption) {
    font-size: 0.85rem; color: var(--text-muted);
    text-align: center; margin-top: 8px;
  }

  /* Sidebar */
  .article-sidebar { position: sticky; top: 88px; }
  .sidebar-cta {
    background: var(--bg-dark); color: var(--text-cream);
    padding: 28px; border-radius: var(--radius-card);
    margin-bottom: 24px;
  }
  .sidebar-cta__title {
    font-family: var(--font-heading); font-size: 1.3rem;
    margin-bottom: 8px;
  }
  .sidebar-cta__text { font-size: 0.88rem; color: var(--text-muted); margin-bottom: 20px; line-height: 1.5; }
  .sidebar-cta__button {
    display: block; text-align: center;
    background: var(--accent); color: #fff;
    padding: 12px 20px; border-radius: var(--radius-btn);
    font-size: 0.8rem; font-weight: 600;
    text-transform: uppercase; letter-spacing: 0.04em;
    transition: background 0.2s;
  }
  .sidebar-cta__button:hover { background: var(--accent-light); }

  .sidebar-contact {
    padding: 20px; border-radius: var(--radius-card);
    border: 1px solid var(--divider); margin-bottom: 24px;
  }
  .sidebar-contact__label { font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.08em; margin-bottom: 6px; }
  .sidebar-contact__phone { font-size: 1.1rem; font-weight: 600; }

  .sidebar-tags { padding: 20px; border-radius: var(--radius-card); border: 1px solid var(--divider); }
  .sidebar-tags__label { font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.08em; margin-bottom: 12px; }
  .sidebar-tags__list { display: flex; flex-wrap: wrap; gap: 6px; }
  .sidebar-tag {
    padding: 4px 12px; border-radius: var(--radius-btn);
    font-size: 0.75rem; background: var(--bg-alt); color: var(--text-body);
  }

  /* CTA Block */
  .post-cta { margin-bottom: 40px; }
  .post-cta__inner {
    background: var(--bg-dark); color: var(--text-cream);
    text-align: center; padding: 64px 40px;
    border-radius: var(--radius-card);
  }
  .post-cta__title { font-family: var(--font-heading); font-size: clamp(1.6rem, 3vw, 2.4rem); margin-bottom: 12px; }
  .post-cta__text { font-size: 1rem; color: var(--text-muted); margin-bottom: 28px; }
  .post-cta__button {
    display: inline-block; background: var(--accent); color: #fff;
    padding: 14px 36px; border-radius: var(--radius-btn);
    font-size: 0.85rem; font-weight: 600;
    letter-spacing: 0.04em; text-transform: uppercase;
    transition: background 0.2s;
  }
  .post-cta__button:hover { background: var(--accent-light); }

  @media (max-width: 1024px) {
    .article-layout { grid-template-columns: 1fr; gap: 40px; }
    .article-sidebar { position: static; }
  }
</style>
