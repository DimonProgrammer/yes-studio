---
import BlogLayout from '../layouts/BlogLayout.astro'
import RelatedPosts from '../components/RelatedPosts.astro'
import { getAllSlugs, getPost, getRelatedPosts, urlFor } from '../lib/sanity'
import { toHTML } from '@portabletext/to-html'

export async function getStaticPaths() {
  const slugs = await getAllSlugs()
  return slugs.map((s: any) => ({ params: { slug: s.slug } }))
}

const { slug } = Astro.params
const post = await getPost(slug!)
if (!post) return Astro.redirect('/blog/')

const relatedPosts = await getRelatedPosts(
  post.category?.slug?.current ?? null,
  post._id
)

const coverUrl = post.coverImage
  ? urlFor(post.coverImage).width(1200).height(630).format('webp').url()
  : undefined

const date = new Date(post.publishedAt).toLocaleDateString('ru-RU', {
  day: 'numeric', month: 'long', year: 'numeric'
})

// Render Portable Text to HTML
const bodyHtml = post.body ? toHTML(post.body, {
  components: {
    types: {
      image: ({ value }: any) => {
        const src = urlFor(value).width(800).format('webp').url()
        return `<figure class="article-image">
          <img src="${src}" alt="${value.alt || ''}" loading="lazy" width="800">
          ${value.caption ? `<figcaption>${value.caption}</figcaption>` : ''}
        </figure>`
      },
    },
    marks: {
      link: ({ children, value }: any) => {
        const target = value.blank ? ' target="_blank" rel="noopener noreferrer"' : ''
        return `<a href="${value.href}"${target}>${children}</a>`
      },
    },
  },
}) : ''
---

<BlogLayout
  title={post.seoTitle || post.title}
  description={post.seoDescription || post.excerpt}
  ogImage={coverUrl}
  ogType="article"
  canonical={`https://yes-studio.agency/blog/${slug}/`}
>
  <article class="article-page">
    <div class="article-container">
      <!-- Breadcrumb -->
      <nav class="breadcrumb" aria-label="Навигация">
        <a href="/" class="breadcrumb__link">Главная</a>
        <span class="breadcrumb__sep">/</span>
        <a href="/blog/" class="breadcrumb__link">Блог</a>
        <span class="breadcrumb__sep">/</span>
        <span class="breadcrumb__current">{post.title}</span>
      </nav>

      <!-- Article Header -->
      <header class="article-header">
        <div class="article-meta">
          {post.category && <span class="article-meta__tag">{post.category.title}</span>}
          <span class="article-meta__date">{date}</span>
          {post.readTime && <span class="article-meta__date"> · {post.readTime} мин</span>}
        </div>
        <h1 class="article-title">{post.title}</h1>
        <p class="article-excerpt">{post.excerpt}</p>
      </header>

      <!-- Cover Image / Placeholder -->
      {coverUrl ? (
        <div class="article-cover">
          <img src={coverUrl} alt={post.coverImage?.alt || post.title} width="1200" height="630">
        </div>
      ) : (
        <div class="article-cover article-cover--placeholder">
          <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round">
            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
            <circle cx="8.5" cy="8.5" r="1.5"/>
            <polyline points="21 15 16 10 5 21"/>
          </svg>
        </div>
      )}

      <!-- Content + Sidebar -->
      <div class="article-layout">
        <div class="article-body" set:html={bodyHtml} />

        <aside class="article-sidebar">
          <div class="sidebar-cta">
            <p class="sidebar-cta__title">Хочешь попробовать?</p>
            <p class="sidebar-cta__text">Оставь заявку — мы всему научим и поддержим на старте</p>
            <a href="https://t.me/studio_yes" class="sidebar-cta__btn">
              <svg class="sidebar-cta__icon" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm4.64 6.8c-.15 1.58-.8 5.42-1.13 7.19-.14.75-.42 1-.68 1.03-.58.05-1.02-.38-1.58-.75-.88-.58-1.38-.94-2.23-1.5-.99-.65-.35-1.01.22-1.59.15-.15 2.71-2.48 2.76-2.69.01-.03.01-.14-.07-.2-.08-.06-.19-.04-.27-.02-.12.03-1.99 1.27-5.62 3.72-.53.36-1.01.54-1.44.53-.47-.01-1.38-.27-2.06-.49-.83-.27-1.49-.42-1.43-.88.03-.24.37-.49 1.02-.75 3.98-1.73 6.64-2.88 7.97-3.44 3.8-1.58 4.59-1.86 5.1-1.87.11 0 .37.03.54.17.14.12.18.28.2.47-.01.06.01.24 0 .37z"/></svg>
              Написать в Telegram
            </a>
          </div>

          <div class="sidebar-block">
            <p class="sidebar-block__label">Позвонить</p>
            <a href="tel:+79639380267" class="sidebar-block__phone">
              <svg class="phone-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M22 16.92v3a2 2 0 01-2.18 2 19.79 19.79 0 01-8.63-3.07 19.5 19.5 0 01-6-6A19.79 19.79 0 012.12 4.18 2 2 0 014.11 2h3a2 2 0 012 1.72c.127.96.361 1.903.7 2.81a2 2 0 01-.45 2.11L8.09 9.91a16 16 0 006 6l1.27-1.27a2 2 0 012.11-.45c.907.339 1.85.573 2.81.7A2 2 0 0122 16.92z"/></svg>
              +7 (963) 938-02-67
            </a>
          </div>

          {post.tags && post.tags.length > 0 && (
            <div class="sidebar-block">
              <p class="sidebar-block__label">Теги</p>
              <div class="sidebar-tags">
                {post.tags.map((tag: string) => (
                  <span class="sidebar-tag">{tag}</span>
                ))}
              </div>
            </div>
          )}
        </aside>
      </div>
    </div>
  </article>

  <!-- Related Posts -->
  <RelatedPosts posts={relatedPosts} />

  <!-- CTA Block -->
  <section class="section section--dark post-cta-section">
    <div class="article-container">
      <div class="post-cta__inner">
        <span class="label--muted">Начать</span>
        <h2 class="post-cta__h2">Готова начать зарабатывать?</h2>
        <p class="post-cta__text">Оставь заявку — мы расскажем всё на личной встрече</p>
        <a href="https://t.me/studio_yes" class="btn btn--cream">
          <svg class="btn__tg-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm4.64 6.8c-.15 1.58-.8 5.42-1.13 7.19-.14.75-.42 1-.68 1.03-.58.05-1.02-.38-1.58-.75-.88-.58-1.38-.94-2.23-1.5-.99-.65-.35-1.01.22-1.59.15-.15 2.71-2.48 2.76-2.69.01-.03.01-.14-.07-.2-.08-.06-.19-.04-.27-.02-.12.03-1.99 1.27-5.62 3.72-.53.36-1.01.54-1.44.53-.47-.01-1.38-.27-2.06-.49-.83-.27-1.49-.42-1.43-.88.03-.24.37-.49 1.02-.75 3.98-1.73 6.64-2.88 7.97-3.44 3.8-1.58 4.59-1.86 5.1-1.87.11 0 .37.03.54.17.14.12.18.28.2.47-.01.06.01.24 0 .37z"/></svg>
          Написать в Telegram
        </a>
      </div>
    </div>
  </section>

  <!-- Schema.org: BlogPosting + BreadcrumbList -->
  <script type="application/ld+json" set:html={JSON.stringify([
    {
      "@context": "https://schema.org",
      "@type": "BlogPosting",
      "headline": post.title,
      "description": post.excerpt,
      "image": coverUrl,
      "datePublished": post.publishedAt,
      "dateModified": post.publishedAt,
      "author": { "@type": "Organization", "name": "YES Studio" },
      "publisher": {
        "@type": "Organization",
        "name": "YES Studio",
        "url": "https://yes-studio.agency/"
      },
      "mainEntityOfPage": `https://yes-studio.agency/blog/${slug}/`
    },
    {
      "@context": "https://schema.org",
      "@type": "BreadcrumbList",
      "itemListElement": [
        { "@type": "ListItem", "position": 1, "name": "Главная", "item": "https://yes-studio.agency/" },
        { "@type": "ListItem", "position": 2, "name": "Блог", "item": "https://yes-studio.agency/blog/" },
        { "@type": "ListItem", "position": 3, "name": post.title }
      ]
    }
  ])} />
</BlogLayout>

<style>
  /* ── Article Container (narrower than global) ── */
  .article-container {
    max-width: 960px;
    margin: 0 auto;
    padding: 0 var(--side-pad);
  }

  /* ── Breadcrumb ── */
  .breadcrumb {
    padding: 24px 0;
    font-size: 12px;
    color: var(--text-muted);
    letter-spacing: 0.02em;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }
  .breadcrumb__link {
    color: var(--text-muted);
    transition: color 0.2s;
  }
  .breadcrumb__link:hover { color: var(--text); }
  .breadcrumb__sep { margin: 0 8px; color: var(--text-muted); opacity: 0.5; }
  .breadcrumb__current {
    color: var(--text-muted);
    opacity: 0.7;
  }

  /* ── Article Header ── */
  .article-page { padding-top: 16px; padding-bottom: 100px; }
  .article-header { max-width: 680px; margin-bottom: 32px; }
  .article-meta {
    display: flex; gap: 10px; align-items: center;
    margin-bottom: 20px;
  }
  .article-meta__tag {
    display: inline-block;
    padding: 5px 14px;
    font-size: 11px; font-weight: 500;
    letter-spacing: 0.08em; text-transform: uppercase;
    border: 1px solid var(--text);
    border-radius: var(--radius-btn);
    color: var(--text); line-height: 1;
  }
  .article-meta__date {
    font-size: 12px; color: var(--text-muted);
    letter-spacing: 0.02em;
  }
  .article-title {
    font-family: var(--font-heading);
    font-size: clamp(26px, 3.5vw, 42px);
    font-weight: 400; line-height: 1.15;
    letter-spacing: 0.02em; text-transform: uppercase;
    color: var(--text); margin-bottom: 16px;
  }
  .article-excerpt {
    font-size: 15px; color: var(--text-body);
    line-height: 1.65; max-width: 580px;
  }

  /* ── Cover Image ── */
  .article-cover {
    margin-bottom: 40px;
    border-radius: var(--radius-photo);
    overflow: hidden;
  }
  .article-cover img { width: 100%; height: auto; display: block; }

  .article-cover--placeholder {
    background: var(--bg-alt);
    display: flex; align-items: center; justify-content: center;
    height: 320px;
    color: var(--text-muted);
    opacity: 0.5;
  }

  /* ── Layout: Content + Sidebar ── */
  .article-layout {
    display: grid;
    grid-template-columns: 1fr 260px;
    gap: 48px; align-items: start;
  }

  /* ── Article Body Typography ── */
  .article-body {
    font-size: 15px; line-height: 1.8;
    color: var(--text-body);
    max-width: 640px;
  }
  .article-body :global(h2) {
    font-family: var(--font-heading); font-size: 26px;
    font-weight: 400; text-transform: uppercase;
    letter-spacing: 0.01em;
    margin: 48px 0 16px; line-height: 1.2;
    color: var(--text);
  }
  .article-body :global(h3) {
    font-family: var(--font-heading); font-size: 20px;
    font-weight: 400;
    margin: 36px 0 12px; line-height: 1.3;
    color: var(--text);
  }
  .article-body :global(p) { margin-bottom: 20px; }
  .article-body :global(a) { color: var(--accent); text-decoration: underline; }
  .article-body :global(a:hover) { color: var(--accent-light); }
  .article-body :global(strong) { font-weight: 600; color: var(--text); }
  .article-body :global(blockquote) {
    border-left: 3px solid var(--accent);
    padding: 16px 0 16px 24px; margin: 28px 0;
    font-style: italic; color: var(--text-muted);
    background: var(--bg-alt); border-radius: 0 12px 12px 0;
  }
  .article-body :global(ul), .article-body :global(ol) {
    margin: 16px 0; padding-left: 24px;
  }
  .article-body :global(li) { margin-bottom: 8px; }
  .article-body :global(.article-image) { margin: 32px 0; }
  .article-body :global(.article-image img) { border-radius: 12px; }
  .article-body :global(.article-image figcaption) {
    font-size: 12px; color: var(--text-muted);
    text-align: center; margin-top: 8px;
  }

  /* ── Sidebar ── */
  .article-sidebar {
    position: sticky; top: 88px;
    display: flex; flex-direction: column; gap: 12px;
  }

  .sidebar-cta {
    background: var(--bg-dark); color: var(--text-cream);
    padding: 16px 20px 20px; border-radius: 16px;
  }
  .sidebar-cta__title {
    font-family: var(--font-heading); font-size: 22px;
    margin-bottom: 8px; letter-spacing: 0.01em;
    line-height: 1.2;
  }
  .sidebar-cta__text {
    font-size: 14px; color: rgba(245,240,235,0.55);
    margin-bottom: 16px; line-height: 1.55;
  }
  .sidebar-cta__btn {
    display: inline-flex; align-items: center; gap: 8px;
    background: var(--text-cream); color: var(--text);
    padding: 12px 20px; border-radius: var(--radius-btn);
    font-size: 11px; font-weight: 600;
    text-transform: uppercase; letter-spacing: 0.06em;
    text-decoration: none;
    transition: opacity 0.2s, transform 0.2s;
    white-space: nowrap;
  }
  .sidebar-cta__btn:hover { opacity: 0.88; transform: translateY(-1px); }
  .sidebar-cta__icon { width: 16px; height: 16px; flex-shrink: 0; }

  .sidebar-block {
    padding: 14px 20px 18px; border-radius: 16px;
    background: var(--bg-card);
    border: 1px solid rgba(170, 168, 159, 0.15);
  }
  .sidebar-block__label {
    font-size: 10px; color: var(--text-muted);
    text-transform: uppercase; letter-spacing: 0.1em;
    font-weight: 500; margin-bottom: 10px;
  }
  .sidebar-block__phone {
    display: flex; align-items: center; gap: 10px;
    font-size: 16px; font-weight: 600;
    color: var(--text);
    text-decoration: none;
    transition: opacity 0.2s;
    letter-spacing: 0.01em;
  }
  .sidebar-block__phone:hover { opacity: 0.7; }
  .phone-icon { width: 18px; height: 18px; flex-shrink: 0; color: var(--text-muted); }

  .sidebar-tags { display: flex; flex-wrap: wrap; gap: 8px; }
  .sidebar-tag {
    padding: 6px 14px; border-radius: var(--radius-btn);
    font-size: 11px; font-weight: 500;
    letter-spacing: 0.03em; text-transform: uppercase;
    background: var(--bg-alt); color: var(--text-body);
    line-height: 1;
  }

  /* ── CTA Section ── */
  .section { padding: var(--section-pad) 0; }
  .section--dark { background: var(--bg-dark); }
  .post-cta-section { position: relative; overflow: hidden; margin-top: 80px; }
  .post-cta__inner { text-align: center; }
  .label--muted {
    font-size: 11px; font-weight: 500;
    letter-spacing: 0.12em; text-transform: uppercase;
    color: rgba(245,240,235,0.4);
    display: block; margin-bottom: 12px;
  }
  .post-cta__h2 {
    font-family: var(--font-heading);
    font-size: clamp(28px, 3.5vw, 44px);
    font-weight: 400; line-height: 1.1;
    letter-spacing: 0.02em; text-transform: uppercase;
    color: var(--text-cream); margin-bottom: 16px;
  }
  .post-cta__text {
    font-size: 15px; color: rgba(245,240,235,0.7);
    margin-bottom: 32px; line-height: 1.65;
  }
  .btn {
    display: inline-flex; align-items: center; gap: 8px;
    padding: 15px 40px;
    font-family: var(--font); font-size: 12px; font-weight: 500;
    letter-spacing: 0.1em; text-transform: uppercase;
    border: none; border-radius: var(--radius-btn);
    cursor: pointer; text-decoration: none; transition: all 0.3s ease;
  }
  .btn--cream { background: var(--text-cream); color: var(--text); }
  .btn--cream:hover { opacity: 0.88; transform: translateY(-1px); }
  .btn__tg-icon { width: 16px; height: 16px; flex-shrink: 0; }

  /* ── Responsive ── */
  @media (max-width: 1024px) {
    .article-layout { grid-template-columns: 1fr; gap: 32px; }
    .article-sidebar { position: static; }
    .article-body { max-width: 100%; }
  }
  @media (max-width: 768px) {
    .article-page { padding-top: 8px; }
    .article-title { font-size: clamp(22px, 6vw, 36px); }
    .article-excerpt { font-size: 14px; }
    .article-cover--placeholder { height: 200px; }
    .article-layout { gap: 24px; }
    .article-body { font-size: 14px; line-height: 1.75; }
    .article-body :global(h2) { font-size: 22px; margin: 36px 0 12px; }
    .article-body :global(h3) { font-size: 18px; margin: 28px 0 10px; }
    .sidebar-cta { padding: 14px 16px 18px; }
    .sidebar-cta__title { font-size: 20px; }
    .sidebar-cta__btn { font-size: 10px; padding: 12px 16px; }
    .sidebar-block { padding: 12px 16px 16px; }
    .post-cta__h2 { font-size: clamp(24px, 6vw, 36px); }
    .breadcrumb { font-size: 11px; padding: 16px 0; }
  }
  @media (max-width: 480px) {
    .article-container { padding: 0 16px; }
    .article-header { margin-bottom: 24px; }
    .article-cover--placeholder { height: 160px; }
    .article-meta { flex-wrap: wrap; gap: 8px; }
  }
</style>
